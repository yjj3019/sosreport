# ==============================================================================
# AIBox Unified Server - Improved Nginx Configuration
# ------------------------------------------------------------------------------
# Key Improvements:
# 1. Simplified API Proxy: Removed unnecessary `rewrite` by using a trailing
#    slash in `proxy_pass`.
# 2. Removed Redundant Location: Eliminated the unused and potentially
#    insecure `/data/iso/AIBox/upload` location block. All API traffic,
#    including uploads, is handled by the `/AIBox/api/` block.
# 3. Consolidated Static Files: Merged static file serving into a single
#    `/AIBox/` location block for easier management.
# ==============================================================================

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # Set the global maximum upload size. This applies to all locations.
    client_max_body_size 100G;

    # Default root and index for requests that don't match other locations.
    root /data/iso/nmonchart;
    index index.html index.htm;

    # ================================================================
    # API Proxy (/AIBox/api/)
    # Forwards all API requests to the Python backend server on port 5000.
    # ================================================================
    location /AIBox/api/ {
        # [IMPROVED] By adding a trailing slash to the proxy_pass URL,
        # Nginx automatically maps the request URI.
        # Example: /AIBox/api/health -> http://127.0.0.1:5000/api/health
        # This removes the need for the `rewrite` directive.
        proxy_pass http://127.0.0.1:5000/api/;

        # Set generous timeouts for long-running AI analysis tasks.
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

        # Forward essential headers to the backend application.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Required for WebSocket and streaming responses from the LLM.
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Disable buffering for real-time streaming of AI responses.
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ================================================================
    # [REMOVED] The `/data/iso/AIBox/upload` location block was removed.
    # It was redundant because uploads are handled by the `/AIBox/api/upload`
    # endpoint, which is covered by the location block above.
    # ================================================================

    # ================================================================
    # Static Asset Serving (HTML, JS, CSS, and Reports)
    # Serves all front-end files and generated reports.
    # ================================================================
    location /AIBox {
        # [IMPROVED] This single `alias` directive now handles all static files,
        # including UI pages (e.g., /AIBox/upload.html) and reports
        # (e.g., /AIBox/output/report.html).
        alias /data/iso/AIBox;
        
        # Default file to serve if a directory is requested.
        index index.html index.htm;
        
        # If a requested file or directory is not found, return a 404 error.
        try_files $uri $uri/ =404;
    }

    # --- Custom Error Pages ---
    error_page 404 /404.html;
    location = /404.html {
        # Serve error pages from the application's root directory.
        root /data/iso/AIBox/;
        # `internal` ensures these pages are not directly accessible by clients.
        internal;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /data/iso/AIBox/;
        internal;
    }
}

