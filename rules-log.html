<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIBox 로그 패턴 관리</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754;
            --danger-color: #dc3545; --warning-color: #ffc107; --background-color: #f4f7f9; --surface-color: #ffffff;
            --text-color: #212529; --header-bg: linear-gradient(135deg, #0d1b2a 0%, #1a2c42 100%);
            --header-text: #ffffff; --border-color: #e9ecef; --shadow: 0 6px 24px rgba(0,0,0,0.07);
            --shadow-hover: 0 8px 32px rgba(0,0,0,0.1); --code-bg: #282c34;
            --input-bg: #fdfdff;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 2.5rem; }
        .container { background: var(--surface-color); border-radius: 16px; box-shadow: var(--shadow); width: 100%; max-width: 1200px; margin: auto; overflow: hidden; }
        .header { background: var(--header-bg); color: var(--header-text); padding: 2.5rem; text-align: center; }
        .header h1 { margin: 0; font-size: 2.25rem; font-weight: 700; }
        .content { padding: 2.5rem; }
        .section-card { border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 2rem; }
        .section-header { background-color: #f8f9fa; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .section-header h2 { font-size: 1.25rem; margin: 0; color: #1a2c42; }
        .section-body { padding: 1.5rem; }
        
        .pattern-editor-form { display: grid; grid-template-columns: 150px 1fr; gap: 1rem; align-items: center; }
        .pattern-editor-form label { font-weight: 500; text-align: right; color: #495057; }
        .pattern-editor-form input, .pattern-editor-form textarea {
            width: 100%; border: 1px solid #ced4da; border-radius: 6px;
            padding: 0.75rem 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
            line-height: 1.6; background-color: var(--input-bg); resize: vertical; box-sizing: border-box;
        }
        .pattern-editor-form input { height: 44px; font-family: 'Noto Sans KR', sans-serif; }
        .pattern-editor-form textarea { min-height: 80px; }
        .pattern-editor-form input:focus, .pattern-editor-form textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }
        .pattern-editor-form .checkbox-container { display: flex; align-items: center; gap: 0.5rem; }
        .pattern-editor-form input[type="checkbox"] { width: auto; height: auto; }

        .pattern-list-table { width: 100%; border-collapse: collapse; }
        .pattern-list-table th, .pattern-list-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        .pattern-list-table thead th { background-color: #f8f9fa; font-weight: 500; }
        .pattern-list-table tbody tr { cursor: pointer; transition: background-color 0.2s ease; }
        .pattern-list-table tbody tr:hover, .pattern-list-table tbody tr.selected { background-color: #e9f5ff; }
        .pattern-list-table .pattern-name { font-weight: 500; }
        .pattern-list-table .pattern-regex { font-family: 'JetBrains Mono', monospace; color: var(--primary-color); max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* [사용자 요청] 무시된 패턴 스타일 */
        .pattern-list-table tbody tr.ignored-row { background-color: #f8f9fa; color: #adb5bd; }
        .pattern-list-table tbody tr.ignored-row .pattern-regex { color: #adb5bd; text-decoration: line-through; }
        .badge { display: inline-block; padding: 0.25em 0.6em; font-size: 0.75em; font-weight: 700; line-height: 1; color: #fff; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; margin-left: 0.5rem; }
        .badge.warning { background-color: var(--warning-color); color: #000; }

        .button {
            background-color: var(--primary-color); color: white; border: none; padding: 0.7rem 1.2rem;
            border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500;
            transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .button.secondary { background-color: var(--secondary-color); }
        .button.success { background-color: var(--success-color); }
        .button.danger { background-color: var(--danger-color); }
        .button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--surface-color); padding: 2.5rem; width: 90%; max-width: 450px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        #main-content { display: none; }
        .icon { width: 1.2em; height: 1.2em; }
        .form-actions, .table-actions { display: flex; gap: 0.75rem; }
    </style>
</head>
<body>

    <div id="password-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2 style="text-align: center;">비밀번호 인증</h2>
            <p style="text-align: center; color: #6c757d; margin-bottom: 1.5rem;">로그 패턴 관리를 위해 비밀번호를 입력하세요.</p>
            <input type="password" id="password-input" placeholder="비밀번호" style="width:100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 1.5rem;">
            <button id="password-submit" class="button" style="width: 100%;">인증</button>
            <p id="password-error" style="color:red; display:none; margin-top:1rem; text-align:center;"></p>
        </div>
    </div>

    <div id="main-content" class="container">
        <header class="header">
            <h1>AIBox Log Pattern Manager</h1>
        </header>

        <div class="content">
            <div class="section-card">
                <div class="section-header">
                    <h2 id="editor-title">새 로그 패턴 추가</h2>
                </div>
                <div class="section-body">
                    <div class="pattern-editor-form">
                        <input type="hidden" id="pattern-index">
                        <label for="pattern-name">Name</label> <input type="text" id="pattern-name" placeholder="패턴 이름 (예: IPv4 Address)">
                        <label for="pattern-regex">Regex</label> <textarea id="pattern-regex" placeholder="정규식 (예: \b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b)"></textarea>
                        <label for="pattern-placeholder">Placeholder</label> <input type="text" id="pattern-placeholder" placeholder="대체될 문자열 (예: <IP_ADDRESS>)">
                        
                        <label for="pattern-ignorecase">Options</label>
                        <div style="display: flex; gap: 1.5rem;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="pattern-ignorecase">
                                <label for="pattern-ignorecase" style="text-align: left; font-weight: normal; margin-left: 0.3rem;">대소문자 무시</label>
                            </div>
                            <!-- [사용자 요청] ignore: true 옵션 추가 -->
                            <div class="checkbox-container">
                                <input type="checkbox" id="pattern-ignore">
                                <label for="pattern-ignore" style="text-align: left; font-weight: normal; color: var(--danger-color); margin-left: 0.3rem;">분석 제외 (노이즈)</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions" style="grid-column: 2; margin-top: 1.5rem;">
                        <button id="save-pattern-btn" class="button success">패턴 저장</button>
                        <button id="clear-form-btn" class="button secondary">새 패턴 작성</button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header"><h2>로그 패턴 목록</h2></div>
                <div class="section-body">
                    <table id="patterns-table" class="pattern-list-table">
                        <thead><tr><th>Name</th><th>Regex</th><th>Placeholder</th><th style="width: 180px;">Actions</th></tr></thead>
                        <tbody><!-- 패턴 목록이 여기에 렌더링됩니다. --></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_BASE_URL = '/AIBox/api';
    let serverPassword = null;
    let allPatterns = [];

    // --- DOM Elements ---
    const passwordModal = document.getElementById('password-modal');
    const mainContent = document.getElementById('main-content');
    const passwordInput = document.getElementById('password-input');
    const passwordSubmitBtn = document.getElementById('password-submit');
    const passwordError = document.getElementById('password-error');
    const patternsTableBody = document.querySelector('#patterns-table tbody');
    
    // Editor Form Elements
    const editorTitle = document.getElementById('editor-title');
    const patternIndexInput = document.getElementById('pattern-index');
    const patternNameInput = document.getElementById('pattern-name');
    const patternRegexTextarea = document.getElementById('pattern-regex');
    const patternPlaceholderInput = document.getElementById('pattern-placeholder');
    const patternIgnorecaseCheckbox = document.getElementById('pattern-ignorecase');
    const patternIgnoreCheckbox = document.getElementById('pattern-ignore'); // [추가]
    const savePatternBtn = document.getElementById('save-pattern-btn');
    const clearFormBtn = document.getElementById('clear-form-btn');

    // --- Helper for API calls ---
    async function robustFetch(url, options) {
        try {
            const response = await fetch(url, options);
            const responseText = await response.text();
            if (!response.ok) throw new Error(responseText || `Server Error (${response.status})`);
            return responseText ? JSON.parse(responseText) : {};
        } catch (error) {
            console.error('Fetch Error:', error);
            throw new Error(`서버 통신 실패: ${error.message}`);
        }
    }

    // --- Authentication ---
    async function verifyPassword() {
        const password = passwordInput.value;
        if (!password) {
            showError("비밀번호를 입력하세요.");
            return;
        }
        passwordSubmitBtn.disabled = true;
        passwordSubmitBtn.textContent = '확인 중...';
        try {
            const result = await robustFetch(`${API_BASE_URL}/verify-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (result.success) {
                serverPassword = password;
                passwordModal.style.display = 'none';
                mainContent.style.display = 'block';
                await loadPatterns();
            } else {
                throw new Error("비밀번호가 올바르지 않습니다.");
            }
        } catch (error) {
            showError(error.message);
        } finally {
            passwordSubmitBtn.disabled = false;
            passwordSubmitBtn.textContent = '인증';
        }
    }

    function showError(message) {
        passwordError.textContent = message;
        passwordError.style.display = 'block';
    }

    // --- Pattern Management ---
    async function loadPatterns() {
        try {
            const patternsData = await robustFetch(`${API_BASE_URL}/log-patterns`);
            allPatterns = Array.isArray(patternsData) ? patternsData : [];
            renderPatternList();
            clearEditorForm();
        } catch (error) {
            alert(`로그 패턴 로딩 실패: ${error.message}`);
        }
    }

    function renderPatternList() {
        patternsTableBody.innerHTML = '';
        if (allPatterns.length === 0) {
            patternsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">등록된 패턴이 없습니다.</td></tr>';
        } else {
            allPatterns.forEach((pattern, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                // [사용자 요청] ignore: true 패턴 시각화
                const isIgnored = !!pattern.ignore;
                if (isIgnored) {
                    row.classList.add('ignored-row');
                }

                const ignoredBadge = isIgnored ? '<span class="badge warning">IGNORED</span>' : '';

                row.innerHTML = `
                    <td><span class="pattern-name">${pattern.name}</span>${ignoredBadge}</td>
                    <td><div class="pattern-regex">${pattern.regex}</div></td>
                    <td>${pattern.placeholder || ''}</td>
                    <td class="table-actions">
                        <button class="button edit-btn">수정</button>
                        <button class="button danger delete-btn">삭제</button>
                    </td>
                `;
                row.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    populateEditorForm(pattern, index);
                });
                row.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeletePattern(index);
                });
                row.addEventListener('click', () => {
                    document.querySelectorAll('#patterns-table tbody tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    populateEditorForm(pattern, index);
                });
                patternsTableBody.appendChild(row);
            });
        }
    }

    function populateEditorForm(pattern, index) {
        editorTitle.textContent = `패턴 수정: ${pattern.name}`;
        patternIndexInput.value = index;
        patternNameInput.value = pattern.name;
        patternRegexTextarea.value = pattern.regex;
        patternPlaceholderInput.value = pattern.placeholder;
        patternIgnorecaseCheckbox.checked = !!pattern.ignorecase;
        // [사용자 요청] ignore 체크박스 상태 반영
        patternIgnoreCheckbox.checked = !!pattern.ignore;
    }

    function clearEditorForm() {
        editorTitle.textContent = '새 로그 패턴 추가';
        patternIndexInput.value = '';
        patternNameInput.value = '';
        patternRegexTextarea.value = '';
        patternPlaceholderInput.value = '';
        patternIgnorecaseCheckbox.checked = false;
        patternIgnoreCheckbox.checked = false; // [추가]
        document.querySelectorAll('#patterns-table tbody tr').forEach(r => r.classList.remove('selected'));
    }

    function handleDeletePattern(index) {
        const patternName = allPatterns[index].name;
        if (!confirm(`패턴 '${patternName}'를 정말 삭제하시겠습니까?`)) return;
        allPatterns.splice(index, 1);
        saveAllPatterns();
    }

    async function handleSavePattern() {
        const index = patternIndexInput.value;
        const name = patternNameInput.value.trim();
        const regex = patternRegexTextarea.value.trim();
        const placeholder = patternPlaceholderInput.value.trim();
        const isIgnored = patternIgnoreCheckbox.checked;

        // ignore: true가 아닌 경우에만 placeholder 검사 (무시할 패턴은 placeholder 없어도 됨)
        if (!name || !regex || (!isIgnored && !placeholder)) {
            if (isIgnored) {
                 // ignore 패턴인데 name이나 regex가 없는 경우
                 if(!name || !regex) {
                     alert('Name과 Regex는 필수 항목입니다.');
                     return;
                 }
            } else {
                alert('Name, Regex, Placeholder는 필수 항목입니다.');
                return;
            }
        }

        const newPattern = {
            name: name,
            regex: regex,
            placeholder: placeholder
        };
        
        if (patternIgnorecaseCheckbox.checked) newPattern.ignorecase = true;
        if (isIgnored) newPattern.ignore = true; // [사용자 요청] ignore 속성 저장

        if (index !== '') { // 수정
            allPatterns[parseInt(index, 10)] = newPattern;
        } else { // 신규
            allPatterns.push(newPattern);
        }

        await saveAllPatterns();
    }

    async function saveAllPatterns() {
        const originalButtonText = savePatternBtn.textContent;
        savePatternBtn.disabled = true;
        savePatternBtn.textContent = '저장 중...';

        try {
            await robustFetch(`${API_BASE_URL}/log-patterns`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: serverPassword, patterns: allPatterns })
            });
            await loadPatterns();
        } catch (error) {
            alert(`저장 실패: ${error.message}`);
        } finally {
            savePatternBtn.disabled = false;
            savePatternBtn.textContent = originalButtonText;
        }
    }

    // --- Event Listeners ---
    passwordSubmitBtn.addEventListener('click', verifyPassword);
    passwordInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') verifyPassword();
    });
    savePatternBtn.addEventListener('click', handleSavePattern);
    clearFormBtn.addEventListener('click', clearEditorForm);
});
</script>

</body>
</html>
